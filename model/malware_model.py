"""
Model wrapper for malware detection.

Loads a pre-trained Keras model (.keras) and exposes a `predict` method that:
- selects and orders the expected feature columns,
- returns probabilities, binary predictions, human-readable labels, and the
  numeric features DataFrame actually fed to the model.

The model expects the columns listed in `self.selected_features`, in this order.
"""


import os
import pandas as pd
import numpy as np
from tensorflow.keras.models import load_model

class MalwareDetector:
    """Thin service around a Keras classifier"""
    def __init__(self):
        """Load the trained model and define the fixed feature schema."""
        # Resolve absolute path to the .keras file beside the codebase
        BASE_DIR = os.path.dirname(os.path.abspath(__file__))
        model_path = os.path.normpath(os.path.join(BASE_DIR, "../model/ShadowSnare_Model.keras"))
        self.model = load_model(model_path)

        # Fixed feature list (order matters). Must match training time schema.
        self.selected_features = [
            'pslist.nproc', 'pslist.nppid', 'pslist.avg_threads', 'pslist.nprocs64bit', 'pslist.avg_handlers',
            'dlllist.ndlls', 'dlllist.avg_dlls_per_proc',
            'handles.nhandles', 'handles.nport', 'handles.nfile', 'handles.nevent', 'handles.ndesktop',
            'handles.nkey', 'handles.nthread', 'handles.ndirectory', 'handles.nsemaphore', 'handles.ntimer',
            'handles.nsection', 'handles.nmutant',
            'ldrmodules.not_in_load', 'ldrmodules.not_in_init', 'ldrmodules.not_in_mem',
            'ldrmodules.not_in_load_avg', 'ldrmodules.not_in_init_avg', 'ldrmodules.not_in_mem_avg',
            'malfind.ninjections', 'malfind.commitCharge', 'malfind.protection', 'malfind.uniqueInjections',
            'modules.nmodules', 'svcscan.nservices', 'svcscan.kernel_drivers', 'svcscan.fs_drivers',
            'svcscan.process_services', 'svcscan.shared_process_services', 'svcscan.interactive_process_services',
            'svcscan.nactive', 'callbacks.ncallbacks', 'callbacks.nanonymous', 'callbacks.ngeneric',
            'psxview.not_in_pslist', 'psxview.not_in_eprocess_pool', 'psxview.not_in_csrss_handles',
            'psxview.not_in_pslist_false_avg', 'psxview.not_in_eprocess_pool_false_avg', 'psxview.not_in_csrss_handles_false_avg'
        ]

    def predict(self, df: pd.DataFrame):
        """
        Run inference on a DataFrame containing at least `self.selected_features`.

        Parameters
        ----------
        df : pandas.DataFrame
            Source table that includes all required feature columns.

        Returns
        -------
        probabilities : np.ndarray
            Model output probabilities for the positive (malware) class.
        binary_preds : np.ndarray
            Array of 0/1 predictions (threshold 0.5).
        labels : np.ndarray
            'Malware'/'Benign' labels derived from `binary_preds`.
        features_df : pandas.DataFrame
            Numeric features actually fed to the model (ordered subset).
        """
        # Select and order the required features; ensure numeric dtype
        features_df = df[self.selected_features].astype(float)
        
        # Keras predict -> probabilities; then threshold to binary
        probabilities = self.model.predict(features_df)
        binary_preds = (probabilities > 0.5).astype(int).flatten()
        
        # Human-friendly labels for the UI
        labels = np.where(binary_preds == 1, "Malware", "Benign")
        
        
        return probabilities, binary_preds, labels, features_df

