# import numpy as np
# import os
# import joblib
# from tensorflow.keras.models import load_model

# class MalwareDetector:
#     def __init__(self):
#         BASE_DIR = os.path.dirname(os.path.abspath(__file__))

#         # Use os.path.join and os.path.normpath to safely handle cross-platform paths
#         model_path = os.path.normpath(os.path.join(BASE_DIR, "../model/binary_classification_model.keras"))
#         scaler_path = os.path.join(BASE_DIR, "scaler.pkl")

#         self.model = load_model(model_path)
#         self.scaler = joblib.load(scaler_path)

#     def predict(self, raw_data):
#         features = np.char.strip(raw_data).astype(float)
#         normalized_features = self.scaler.transform(features)
#         predictions = self.model.predict(normalized_features)
#         binary_predictions = (predictions > 0.5).astype(int).flatten()
#         labels = np.where(binary_predictions == 1, "Malicious", "Benign")
#         return predictions, binary_predictions, labels


import os
import pandas as pd
import numpy as np
from tensorflow.keras.models import load_model

class MalwareDetector:
    def __init__(self):
        BASE_DIR = os.path.dirname(os.path.abspath(__file__))
        model_path = os.path.normpath(os.path.join(BASE_DIR, "../model/balanced_subset_model.keras"))
        # model_path = os.path.normpath(os.path.join(BASE_DIR, "../model/binary_classification_model.keras"))
        self.model = load_model(model_path)

        self.selected_features = [
            'pslist.nproc', 'pslist.nppid', 'pslist.avg_threads', 'pslist.nprocs64bit', 'pslist.avg_handlers',
            'dlllist.ndlls', 'dlllist.avg_dlls_per_proc',
            'handles.nhandles', 'handles.nport', 'handles.nfile', 'handles.nevent', 'handles.ndesktop',
            'handles.nkey', 'handles.nthread', 'handles.ndirectory', 'handles.nsemaphore', 'handles.ntimer',
            'handles.nsection', 'handles.nmutant',
            'ldrmodules.not_in_load', 'ldrmodules.not_in_init', 'ldrmodules.not_in_mem',
            'ldrmodules.not_in_load_avg', 'ldrmodules.not_in_init_avg', 'ldrmodules.not_in_mem_avg',
            'malfind.ninjections', 'malfind.commitCharge', 'malfind.protection', 'malfind.uniqueInjections',
            'modules.nmodules', 'svcscan.nservices', 'svcscan.kernel_drivers', 'svcscan.fs_drivers',
            'svcscan.process_services', 'svcscan.shared_process_services', 'svcscan.interactive_process_services',
            'svcscan.nactive', 'callbacks.ncallbacks', 'callbacks.nanonymous', 'callbacks.ngeneric',
            'psxview.not_in_pslist', 'psxview.not_in_eprocess_pool', 'psxview.not_in_csrss_handles',
            'psxview.not_in_pslist_false_avg', 'psxview.not_in_eprocess_pool_false_avg', 'psxview.not_in_csrss_handles_false_avg'
        ]

    def predict(self, df: pd.DataFrame):
        features_df = df[self.selected_features].astype(float)
        probabilities = self.model.predict(features_df)
        binary_preds = (probabilities > 0.5).astype(int).flatten()
        labels = np.where(binary_preds == 1, "Malware", "Benign")
        return probabilities, binary_preds, labels, features_df

