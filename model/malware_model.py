import numpy as np
import os
import joblib
from tensorflow.keras.models import load_model

class MalwareDetector:
    def __init__(self):
        BASE_DIR = os.path.dirname(os.path.abspath(__file__))

        # Use os.path.join and os.path.normpath to safely handle cross-platform paths
        model_path = os.path.normpath(os.path.join(BASE_DIR, "../model/binary_classification_model.keras"))
        scaler_path = os.path.join(BASE_DIR, "scaler.pkl")

        self.model = load_model(model_path)
        self.scaler = joblib.load(scaler_path)

    def predict(self, raw_data):
        features = np.char.strip(raw_data).astype(float)
        normalized_features = self.scaler.transform(features)
        predictions = self.model.predict(normalized_features)
        binary_predictions = (predictions > 0.5).astype(int).flatten()
        labels = np.where(binary_predictions == 1, "Malicious", "Benign")
        return predictions, binary_predictions, labels